<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.bootcss.com/twitter-bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./public/css/font-awesome-4.7.0/css/font-awesome.css">
    <link rel="stylesheet" href="./public/css/music.css">
    <link rel="icon" type="image/png" href="public/img/logo.jpg">
    <title>BinYu -- 音乐</title>
</head>
<body>
    <div id='bg'></div>
    <div id='audio-main'>
        <audio preload="auto" autoplay='true' cross-origin="anonymous"></audio>
    </div>
    <div id="music">
        <div class="container">
            <div class="row">
                <div class="col-md-4" id="user-musics">
                    <div id="user">
                        <div class="header">
                            <img src="./public/img/octocat.png" alt="头像">
                        </div>
                    </div>
                    <div id="query">
                        <form class="query-song cf">
                            <div class="dropdown">
                                    <span class="query-k"></span>
                                <div class="dropdown-content">
                                    <div>
                                        <span class="query-163"></span>
                                    </div>
                                </div>
                                
                            </div>
                            <input type="text" class="in">
                            <label for="sub-name"><span class="fa fa-search fa-1x"></span></label>
                            <input type="submit" value="搜索" class="s" id='sub-name'>
                            <span class="line"></span>
                        </form>
                    </div>
                    <div id="music-list">
                        <ul class="list">
                        </ul>
                    </div>
                    <div class="music-option">
                        <span>喜欢</span><span>酷狗</span><span>网易</span>
                    </div>   
                </div>
                <div class="col-md-8" id="music-manage">
                    <div id="lyric">
                        <ul class="lyric-list">
                        </ul>
                    </div>
                    <div id="frequent">
                        <canvas>声音可视化</canvas>
                    </div>
                    <div id="progress">
                        <div></div>
                    </div>
                    <div id="control">
                        <div>
                            <span class="fa fa-heart-o fa-2x love"></span>
                        </div>
                        <div>
                            <span class="fa fa-play fa-2x previous"></span>
                        </div>
                        <div>
                            <span class="fa fa-play-circle fa-2x play-pause"></span>
                        </div>
                        <div>
                            <span class="fa fa-play fa-2x next"></span>
                        </div>
                        <div class="volume">
                            <span class="fa fa-volume-up fa-2x volume-icon">
                                <div class="volume-bar">
                                    <div class="bar"></div>
                                </div>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="public/js/media.js"></script>
    <script src="public/js/music.js"></script>
    <script>

        let ml = new MusicLib(),
            currentPlayList = null;
        let audio = document.querySelector('audio');
        function drawSound(buffer = Uint8Array, ctx = Object, width = Number, heigth = Number, 
                            bar = Number, analyser = AnalyserNode){
            ctx.clearRect(0, 0, width, heigth);
            let bWidth = (width / buffer.length) * 10,
                bHeigth = 0,
                x = 0;
            for(let i = 0; i < buffer.length; i++){
                bHeigth = buffer[i];
                ctx.fillStyle = `rgba(${bHeigth % 10}, ${bHeigth % 10}, ${bHeigth % 10}, ${.5})`;
                ctx.fillRect(x, heigth - bHeigth / 2, bWidth, bHeigth);
                x += bWidth + 1;
            }
        }
        function removeAllChild(parent = Element){
            let rcs = [];
            while(parent.firstElementChild){
                rcs.push(parent.removeChild(parent.firstElementChild));
            } 
            return rcs;
        }
        let el = {
            bg: document.querySelector('#bg'),
            music: document.querySelector('#music'),
            musicList: {
                main: document.querySelector('.list'),
                queryMusic: {
                    input: document.querySelector('.query-song .in'),
                    submit: document.querySelector('.music-list .s'),
                    queryForm: document.querySelector('.query-song')
                }
            },
            control:{
                previous: document.querySelector('.previous'),
                love:document.querySelector('.love'),
                next:document.querySelector('.next'),
                play:document.querySelector('.play-pause'),
                volume:{
                    volumeIcon: document.querySelector('.volume-icon'),
                    self: document.querySelector('.volume-bar'),
                    volumeBar: document.querySelector('.volume-bar .bar')
                }
            },
            musicManage:{
                lyric:{
                    main: document.querySelector('.lyric-list')
                },
                mProgress:{
                    self: document.querySelector('#progress'),
                    bar: document.querySelector('#progress div')
                },
                frequent:{
                    canvas: document.querySelector('canvas')

                }
            },
            user:{
                header: document.querySelector('#user .header')
            }
        };
        let lyricNodes = {},
            pLrcNode = null;
        //歌词更新，什么的
        EventUtil.addEvent(audio, 'timeupdate', (e) => {
            let time = parseInt(audio.currentTime),
                n = lyricNodes[time];
            if(n){
                if(pLrcNode){
                    pLrcNode.style.color = n.style.color;
                }
                n.style.color = 'red';
                pLrcNode = n;
            }
            try{
                n.nextElementSibling.nextElementSibling.nextElementSibling.scrollIntoView(false);
            }catch(ex){
                ;
            }
            el.musicManage.mProgress.bar.style.width = `${(time / audio.duration) * 100}%`;
        });
        //渲染歌曲列表
        function showSongsInfo(name = String, songList = Array, sChildName = 'li'){
            let showParent = el.musicList.main;
            removeAllChild(showParent);
            songList.forEach((info) => {
                let item = document.createElement(sChildName);                
                item.innerText = info.filename;
                item.dataset.hash = info.hash;
                item.dataset.name = name;
                showParent.appendChild(item);
            });
        }
        //双击播放
        EventUtil.addEvent(el.musicList.main, 'dblclick', (e) => {
            let t = e.target,
                hash = null;
            currentPlayList = ml.getSongList(t.dataset.name);
            hash = currentPlayList.query(t.innerText).hash;
            k.getSongInfo({
                value: hash,
                option: 'song'
            }).then((songText) => {
                let songData = JSON.parse(songText);
                console.log(songData);
                el.bg.style.backgroundImage = `url(${songData.img})`;
                EventUtil.tirgger('onePlay', songData);
            });
        });
        //搜索歌曲
        EventUtil.addEvent(el.musicList.queryMusic.queryForm, 'submit', (e) => {
            e.preventDefault();
            let name = el.musicList.queryMusic.input.value;
            if(ml.getSongList(name)){
                showSongsInfo(name, ml.getSongList(name).songList);
            }
            k.getSongInfo({
                value: name,
                option: 'query'
            }).then((text) => {
                let songList = JSON.parse(text).info;
                ml.addList(name, songList);
                showSongsInfo(name, songList);
            });
        });
        let s = null;
        let pState = false;
        function onePlay(eN = String, data = Array){
            if(window.audioCtx === undefined){
                window.audioCtx = new (AudioContext || webkitAudioContext)();
                window.source = window.audioCtx.createMediaElementSource(audio);
                window.analyser = window.audioCtx.createAnalyser();
                window.source.connect(analyser);
                window.analyser.connect(window.audioCtx.destination);
            }
            s = soundVisual(window.analyser, el.musicManage.frequent.canvas, drawSound);
            onePlay = (eN = String, data = Array) => {
                audio.src = k.enUrl(data.play_url);
                pState = true;
                el.control.play.classList.replace('fa-play-circle', 'fa-pause-circle');
                removeAllChild(el.musicManage.lyric.main);
                lyricNodes = l.renderLyric(el.musicManage.lyric.main, data.lyrics);
            };
            onePlay(eN, data);
        }
        function play(){
            if(audio.currentSrc.length === 0){
                return false;
            }
            s.run = true;
            pState = true;
            audio.play();
            el.control.play.classList.replace('fa-play-circle', 'fa-pause-circle');
        }
        function pause(){
            s.run = false;
            pState = false;
            audio.pause();
            el.control.play.classList.replace('fa-pause-circle', 'fa-play-circle');
        }
        //监听按钮
        EventUtil.addEvent(el.control.play, 'click', () => {
            if(pState){
                EventUtil.tirgger('pause');
            }else{
                EventUtil.tirgger('play');
            }
        });
        EventUtil.addEvent(el.musicManage.mProgress.self, 'mousedown', (e) => {
            if(navigator.userAgent.indexOf('Firefox') >= 0){
                alert('兄贵你用的火狐，有些功能并不支持，我小叮当也没办法啊');
                return false;
            }
            let x = e.layerX,
                time = (x / el.musicManage.mProgress.self.offsetWidth * 100) * (audio.duration / 100);
            console.log(time, x, el.musicManage.mProgress.self.offsetWidth);
            audio.currentTime = time;
        })
        EventUtil.addEvent(audio, 'ended', (e) => {
            let hash = currentPlayList.getSong('n').hash;
            k.getSongInfo({
                value: hash,
                option: 'song'
            }).then((songText) => {
                let songData = JSON.parse(songText);
                EventUtil.tirgger('onePlay', songData);
            });
        });
        EventUtil.addEvent(el.control.next, 'click', (e) => {
            let hash = currentPlayList.getSong('n').hash;
            k.getSongInfo({
                value: hash,
                option: 'song'
            }).then((songText) => {
                let songData = JSON.parse(songText);
                EventUtil.tirgger('onePlay', songData);
            });
        });
        EventUtil.addEvent(el.control.previous, 'click', (e) => {
            let hash = currentPlayList.getSong('p').hash;
            k.getSongInfo({
                value: hash,
                option: 'song'
            }).then((songText) => {
                let songData = JSON.parse(songText);
                EventUtil.tirgger('onePlay', songData);
            });
        });
        EventUtil.addEvent(el.control.volume.self, 'click', (e) => {
            let x = e.layerX,
                volume = x / el.control.volume.self.offsetWidth;
            audio.volume = volume;
            el.control.volume.volumeBar.style.width = `${x / el.control.volume.self.offsetWidth * 100}%`;
        });
        //监听第一次播放
        EventUtil.listen('onePlay', onePlay);
        //监听播放
        EventUtil.listen('play', play);
        //监听暂停
        EventUtil.listen('pause', pause);
        window.onload = () => {
            k.getSongInfo({
                value: '冬离秋归',
                option: 'query'
            }).then((text) => {
                let songList = JSON.parse(text).info;
                ml.addList(name, songList);
                showSongsInfo(name, songList);
            });
            alert('豳羽 -- 音乐2.0版本\n主要更新ui，跟部分优化了部分代码，删了不合理的地方\n设计师：范冬雨\n程序员：无名小将');
        };
    </script>
</body>
</html>